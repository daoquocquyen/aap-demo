---
- name: Restart deployments on Secret modified
  hosts: localhost
  gather_facts: false
  vars:
    project: "{{ project }}"
  tasks:
    - name: Get deployments with the restart label
      kubernetes.core.k8s_info:
        api_version: apps/v1
        kind: Deployment
        namespace: "{{ project }}"
        label_selectors:
          - restart-on=demo-secret
      register: deployments

    - name: No deployments found
      ansible.builtin.debug:
        msg: "No deployments found with label 'restart-on=demo-secret' in namespace {{ project }}"
      when: (deployments.resources | default([]) | length) == 0

    - name: Restart deployments by patching annotation
      kubernetes.core.k8s:
        api_version: apps/v1
        kind: Deployment
        name: "{{ item.metadata.name }}"
        namespace: "{{ project }}"
        merge_type: strategic-merge
        definition:
          spec:
            template:
              metadata:
                annotations:
                  secret-restart-timestamp: "{{ lookup('pipe', 'date +%s') }}"
      loop: "{{ deployments.resources | default([]) }}"
      when: (deployments.resources | default([]) | length) > 0